name: ğŸš€ Deploy EHIT Backend

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: ğŸ”‘ Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "Host 165.227.180.118" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
        echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config

  prepare:
    runs-on: ubuntu-latest
    environment: production
    needs: setup
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: ğŸ”‘ Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "Host 165.227.180.118" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
        echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config

    - name: ğŸ“¥ Prepare Server
      run: |
        echo "ğŸ“¥ Preparing server..."
        ssh root@165.227.180.118 "
          # Remove old directory
          rm -rf /opt/ehit_backend
          
          # Create directory for docker-compose
          mkdir -p /opt/ehit_backend/docker/prod
          
          echo 'âœ… Server prepared successfully!'
        "

    - name: ğŸ“¤ Copy Files
      run: |
        echo "ğŸ“¤ Copying files to server..."
        scp docker/prod/docker-compose.yml root@165.227.180.118:/opt/ehit_backend/docker/prod/
        scp docker/prod/Dockerfile root@165.227.180.118:/opt/ehit_backend/docker/prod/
        scp docker/prod/nginx.conf root@165.227.180.118:/opt/ehit_backend/docker/prod/
        echo 'âœ… Files copied successfully!'

  cleanup:
    runs-on: ubuntu-latest
    environment: production
    needs: prepare
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: ğŸ”‘ Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "Host 165.227.180.118" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
        echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config

    - name: ğŸ”„ Deploy Services
      run: |
        echo "ğŸ”„ Deploying services..."
        ssh root@165.227.180.118 "
          cd /opt/ehit_backend
          
          # Stop all containers first
          echo 'ğŸ›‘ Stopping all containers...'
          docker-compose -f docker/prod/docker-compose.yml down || true
          
          # Remove all containers and images to force complete rebuild
          echo 'ğŸ—‘ï¸ Removing containers and images...'
          docker system prune -a --volumes -f
          
          # Rebuild and restart all containers from scratch
          echo 'ğŸ”§ Rebuilding all containers from scratch...'
          docker-compose -f docker/prod/docker-compose.yml up -d --build --force-recreate
          
          echo 'âœ… Services deployed successfully!'
        "

  deploy:
    runs-on: ubuntu-latest
    environment: production
    needs: cleanup
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: ğŸ”‘ Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "Host 165.227.180.118" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
        echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config

    - name: â³ Wait for Services
      run: |
        echo "â³ Waiting for services..."
        ssh root@165.227.180.118 "
          # Wait for services
          echo 'â³ Waiting for services...'
          sleep 30
          
          # Wait for database
          echo 'ğŸ—„ï¸ Waiting for database...'
          sleep 10
          docker-compose -f /opt/ehit_backend/docker/prod/docker-compose.yml exec -T db pg_isready -U ehit_user
          
          echo 'âœ… Services are ready!'
        "

  migrate:
    runs-on: ubuntu-latest
    environment: production
    needs: deploy
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: ğŸ”‘ Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "Host 165.227.180.118" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
        echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config

    - name: ğŸ“ Create Migrations
      run: |
        echo "ğŸ“ Creating migrations..."
        ssh root@165.227.180.118 "
          cd /opt/ehit_backend
          docker-compose -f docker/prod/docker-compose.yml exec -T web python manage.py makemigrations
          echo 'âœ… Migrations created successfully!'
        "

    - name: ğŸ—„ï¸ Run Migrations
      run: |
        echo "ğŸ—„ï¸ Running migrations..."
        ssh root@165.227.180.118 "
          cd /opt/ehit_backend
          docker-compose -f docker/prod/docker-compose.yml exec -T web python manage.py migrate
          echo 'âœ… Migrations completed successfully!'
        "

    - name: ğŸ“¦ Collect Static Files
      run: |
        echo "ğŸ“¦ Collecting static files..."
        ssh root@165.227.180.118 "
          cd /opt/ehit_backend
          docker-compose -f docker/prod/docker-compose.yml exec -T web python manage.py collectstatic --noinput
          echo 'âœ… Static files collected successfully!'
        "

    - name: ğŸµ Populate Genres
      run: |
        echo "ğŸµ Populating genres..."
        ssh root@165.227.180.118 "
          cd /opt/ehit_backend
          docker-compose -f docker/prod/docker-compose.yml exec -T web python populate_genres.py
          echo 'âœ… Genres populated successfully!'
        "

  verify:
    runs-on: ubuntu-latest
    environment: production
    needs: migrate
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: ğŸ”‘ Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "Host 165.227.180.118" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
        echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config

    - name: ğŸ“Š Show Status
      run: |
        echo "ğŸ“Š Final status..."
        ssh root@165.227.180.118 "
          cd /opt/ehit_backend
          docker-compose -f docker/prod/docker-compose.yml ps
          echo 'ğŸ‰ Deployment completed!'
          echo 'ğŸŒ http://prod.ehitapp.com.br'
        "

    - name: ğŸ” Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        sleep 30
        
        # Test health endpoint
        if curl -f http://prod.ehitapp.com.br/health; then
          echo "âœ… Health check passed!"
        else
          echo "âŒ Health check failed!"
          exit 1
        fi
        
        echo "ğŸ‰ Deployment verified successfully!"